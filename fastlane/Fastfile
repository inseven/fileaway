# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

skip_docs

lane :release do

    # TODO: Add a certificate store.
    # TODO: Read the target name.

    output_directory = "builds"
    output_name = "Fileaway"
    target = File.join(output_directory, output_name + ".app")
    version_number = get_version_number(
        xcodeproj: "macos/Fileaway-macOS.xcodeproj",
        target: "Fileaway"
    )
    commit = last_git_commit
    commit_fingerprint = commit[:abbreviated_commit_hash]
    build_number = commit_fingerprint.capitalize + "." + Time.now.to_i.to_s
    zip_basename = output_name + "-macOS-" + version_number + "-" + build_number + ".zip"
    zip_path = File.join(output_directory, zip_basename)

    # sync_code_signing(
    #     storage_mode: "git",
    #     git_url: "git@github.com:inseven/certificates.git",
    #     type: "development",
    #     username: ENV['APPLE_DEVELOPER_ID']
    # )
    build_app(
        scheme: "Fileaway macOS",
        output_directory: output_directory,
        output_name: output_name,
        export_options: {
            method: "developer-id",
            teamID: ENV['APPLE_TEAM_ID']
        },
        xcargs: "BUILD_NUMBER=" + build_number
    )
    notarize(
        package: target,
        username: ENV['APPLE_DEVELOPER_ID'],
    )
    zip(
        path: target,
        output_path: zip_path
    )

end

lane :test do
    sh("../scripts/test.sh")
end
